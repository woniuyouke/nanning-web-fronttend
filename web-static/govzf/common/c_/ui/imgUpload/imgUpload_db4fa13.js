define("common:components/ui/imgUpload/imgUpload.js",function(t,e,o){var n=t("common:components/ui/zepto/zepto.js"),i=t("common:components/ui/class/class.js"),s=t("common:components/ui/tips/tips.js"),a=t("common:components/ui/exif/exif.js");!function(t){"use strict";if(t.URL=t.URL||t.webkitURL,t.Blob&&t.URL)try{return void new Blob}catch(e){}var o=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||function(t){var e=function(t){return Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1]},o=function(){this.data=[]},n=function(t,e,o){this.data=t,this.size=t.length,this.type=e,this.encoding=o},i=o.prototype,s=n.prototype,a=t.FileReaderSync,r=function(t){this.code=this[this.name=t]},l="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),p=l.length,c=t.URL||t.webkitURL||t,u=c.createObjectURL,f=c.revokeObjectURL,m=c,h=t.btoa,d=t.atob,g=t.ArrayBuffer,R=t.Uint8Array,w=/^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/;for(n.fake=s.fake=!0;p--;)r.prototype[l[p]]=p+1;return c.createObjectURL||(m=t.URL=function(t){var e,o=document.createElementNS("http://www.w3.org/1999/xhtml","a");return o.href=t,"origin"in o||("data:"===o.protocol.toLowerCase()?o.origin=null:(e=t.match(w),o.origin=e&&e[1])),o}),m.createObjectURL=function(t){var e,o=t.type;return null===o&&(o="application/octet-stream"),t instanceof n?(e="data:"+o,"base64"===t.encoding?e+";base64,"+t.data:"URI"===t.encoding?e+","+decodeURIComponent(t.data):h?e+";base64,"+h(t.data):e+","+encodeURIComponent(t.data)):u?u.call(c,t):void 0},m.revokeObjectURL=function(t){"data:"!==t.substring(0,5)&&f&&f.call(c,t)},i.append=function(t){var o=this.data;if(R&&(t instanceof g||t instanceof R)){for(var i="",s=new R(t),l=0,p=s.length;p>l;l++)i+=String.fromCharCode(s[l]);o.push(i)}else if("Blob"===e(t)||"File"===e(t)){if(!a)throw new r("NOT_READABLE_ERR");var c=new a;o.push(c.readAsBinaryString(t))}else t instanceof n?"base64"===t.encoding&&d?o.push(d(t.data)):"URI"===t.encoding?o.push(decodeURIComponent(t.data)):"raw"===t.encoding&&o.push(t.data):("string"!=typeof t&&(t+=""),o.push(unescape(encodeURIComponent(t))))},i.getBlob=function(t){return arguments.length||(t=null),new n(this.data.join(""),t,"raw")},i.toString=function(){return"[object BlobBuilder]"},s.slice=function(t,e,o){var i=arguments.length;return 3>i&&(o=null),new n(this.data.slice(t,i>1?e:this.data.length),o,this.encoding)},s.toString=function(){return"[object Blob]"},s.close=function(){this.size=0,delete this.data},o}(t);t.Blob=function(t,e){var n=e?e.type||"":"",i=new o;if(t)for(var s=0,a=t.length;a>s;s++)i.append(Uint8Array&&t[s]instanceof Uint8Array?t[s].buffer:t[s]);var r=i.getBlob(n);return!r.slice&&r.webkitSlice&&(r.slice=r.webkitSlice),r};var n=Object.getPrototypeOf||function(t){return t.__proto__};t.Blob.prototype=n(new t.Blob)}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content||this),o.exports=i.$factory("imgUpload",{initialize:function(t){this.options=n.extend({inputFile:null,compress:!1,maxSize:102400,compressRatio:[.7,.7,.7,.7],url:null,maxPic:null,onSel:null,onProgress:null,onSuccess:null,onFailure:null,onComplete:null,success:null,mime:{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",bmp:"image/bmp"},type:"",fileFilters:[],fileDeals:[],remainFiles:[],imgEXIF:[]},t||{}),this.getFiles()},getFiles:function(){var t=this,e=n(t.options.inputFile),o=t.options.inputFile,i=o.files;if(void 0===i)return!1;for(var a=0;a<i.length;a++)!function(e){t.options.type=i[e].type,t.options.type||(t.options.type=t.options.mime[i[e].name.match(/\.([^\.]+)$/i)[1]]),/image.(png|jpg|jpeg|bmp)/.test(t.options.type)?t.options.fileFilters.push(i[e]):s.show('您选择的"'+i[e].name+'"文件类型不是图片',3e3,!0)}(a);return e.val(""),t.dealFiles(),!0},dealFiles:function(){for(var t,e=this,o=0;t=e.options.fileFilters[o];o++)t.index=e.options.total,e.options.total++;e.options.url?e.zipfile(e.options.fileFilters):e.zipfileDataURL(e.options.fileFilters[0])},zipfile:function(t){var e=this,o=0,n=[],i=[],a={};e.options.maxPic=e.options.fileNum(),function(o){var r=function(){if(file=t[o],file&&o<e.options.maxPic){var l=new FileReader;l.onload=function(t){function s(){a.DateTime=e.getPhotoOrientation(p,"DateTime");var t=e.compressImg(p);e.options.onSel(l,e.options.fileFilters[o],!1),p=null,n.push(t),i.push(a),o++,r()}var l=t.target.result,p=new Image;p.src=l,file.size<e.options.maxSize?(a.DateTime=e.getPhotoOrientation(p,"DateTime"),e.options.onSel(l,e.options.fileFilters[o],!1),p=null,n.push(l),i.push(a),o++,r()):p.complete?s():p.onload=s},l.onerror=function(){s.destroy(),s.error("图片获取失败!<br/>建议您在图库或相册中选择")},l.readAsDataURL(file)}else e.options.fileDeals=n,e.options.imgEXIF=i,s.destroy(),e.options.onSel("",e.options.fileFilters[o],!0),e.uploadFile()};r()}(o)},uploadFile:function(){for(var t=this,e=t.options.remainFiles=t.options.fileDeals,o=0;o<e.length;o++)!function(o){var n=e[o],i=new FormData,s=t.dataURItoBlob(n,t.options.fileFilters[o].name);i.append("sImg",s);var a=new XMLHttpRequest;a.upload&&(a.onreadystatechange=function(){4===a.readyState&&(200===a.status?t.options.onSuccess(t.options.fileFilters[o],a.responseText,t.options.imgEXIF[o]):t.options.onFailure(t.options.fileFilters[o]),t.funDeleteFile(n),t.options.remainFiles.length||t.options.onComplete())},a.open("POST",t.options.url,!0),a.send(i))}(o)},funDeleteFile:function(t){for(var e=this,o=[],n=0,i=e.options.remainFiles[n];n<e.options.remainFiles.length;n++)i!=t&&o.push(i);e.options.remainFiles=o},getPhotoOrientation:function(t,e){var o;return a.getData(t,function(){o=a.getTag(this,e)}),o},compressImg:function(t){var e,o=this,n=o.getPhotoOrientation(t,"Orientation"),i=document.createElement("canvas"),s=i.getContext("2d"),a=document.createElement("canvas"),r=(a.getContext("2d"),t.src.length),l=(r/1024*.75).toFixed(2),p=t.width,c=t.height;e=1024>l?o.options.compressRatio[0]:2048>l?o.options.compressRatio[1]:3072>l?o.options.compressRatio[2]:o.options.compressRatio[3];var u;(u=p*c/4e6)>1?(u=Math.sqrt(u),p/=u,c/=u):u=1,i.width=p,i.height=c,s.fillStyle="#fff",s.fillRect(0,0,i.width,i.height),6==n?(i.width=c,i.height=p,s.translate(c/2,p/2),s.rotate(90*Math.PI/180),s.drawImage(t,0-p/2,0-c/2,p,c),s.restore()):3==n?(s.translate(p/2,c/2),s.rotate(180*Math.PI/180),s.drawImage(t,0-p/2,0-c/2,p,c),s.restore()):8==n?(i.width=c,i.height=p,s.translate(c/2,p/2),s.rotate(-90*Math.PI/180),s.drawImage(t,0-p/2,0-c/2,p,c),s.restore()):s.drawImage(t,0,0,p,c);var f=i.toDataURL("image/jpeg",e);return a.width=a.height=i.width=i.height=0,f},dataURItoBlob:function(t,e){for(var o=atob(t.split(",")[1]),n=t.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(o.length),s=new Uint8Array(i),a=0;a<o.length;a++)s[a]=o.charCodeAt(a);return new Blob([i],{type:n,filename:e})},zipfileDataURL:function(t){var e=this,o=new FileReader;o.readAsDataURL(t);var n=t.size;o.onload=function(){function t(){var t=e.compressImg(i);e.options.success(t),i=null}var o=this.result;if(!e.options.compress)return void e.options.success(this.result);var i=new Image;i.src=o,n<e.options.maxSize?(e.options.success(this.result),i=null):i.complete?t():i.onload=t}}})});