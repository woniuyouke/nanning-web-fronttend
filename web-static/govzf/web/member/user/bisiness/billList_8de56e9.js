define("web:static/member/user/bisiness/billList.js",function(n){"use strict";n.async(["common:components/jquery/jquery.js","common:components/pcUI/dialog/dialog.js","common:components/pcUI/tips/tips.js","common:components/ui/authAjax/authAjax.js","common:components/ui/template/template.js","common:components/pcUI/util/number.js","common:components/third-party/jquery-qrcode/jquery.qrcode.min.js"],function(n,a,r,t,e,s){var i=null,l={config:{billListUrl:"/web/bill/query",billDetailUrl:"/web/bill/detail",isOpenWallet:"/web/api/payment/regionRegister/check",payBill:"/web/api/payment/generate",billStatusUrl:"/web/api/payment/status/combinepay"},ids:null,billList:"<%\r\n    /**\r\n     * 依据账单不同状态返回对应的状态信息。\r\n     * @param state 0-未激活，1-激活，2-已支付，3-逾期，4-支付中，5-支付失败，6-失效。\r\n     * @returns {*}\r\n     */\r\n    function _payStateInfo(state) {\r\n        switch (~~state) {\r\n            case 0:\r\n            case 1:\r\n            case 5:  // 支付失败，C端统一显示“待支付”\r\n                return {\r\n                    stateclass: 'unpay',\r\n                    text: window.curRentType ? '待收款' : '待支付'\r\n                }\r\n            case 2:\r\n                return {\r\n                    stateclass: 'paid',\r\n                    text: window.curRentType ? '已收款' : '已支付'\r\n                }\r\n            case 3:\r\n                return {\r\n                    stateclass: 'unpay',\r\n                    text: window.curRentType ? '待收款' : '待支付',\r\n                    tips: '已逾期，请尽快支付以免影响您的信用',\r\n                }\r\n            case 4:\r\n                return {\r\n                    stateclass: 'paying',\r\n                    text: '支付中'\r\n                }\r\n            case 6:\r\n                return {\r\n                    stateclass: 'paid',\r\n                    text: '失效'\r\n                }\r\n            default:\r\n                return {\r\n                    stateclass: 'unpay',\r\n                    text: window.curRentType ? '待收款' : '待支付'\r\n                }\r\n        }\r\n    }\r\n\r\n    //根据totalPage,pageNo 生成分页数据\r\n    function getPageList(totalPage, pageNo) {\r\n        var pageArr = [];\r\n        pageArr.push(pageNo);\r\n        while(pageArr.length < 10) {\r\n            var prev = pageArr[0] - 1;\r\n            var next = pageArr[pageArr.length-1] + 1;\r\n            if (prev >= 1 || next <= totalPage) {\r\n                if (prev >= 1) {\r\n                    pageArr.unshift(prev);\r\n                }\r\n                if (next <= totalPage) {\r\n                    pageArr.push(next);\r\n                }\r\n            } else {\r\n                break;\r\n            }\r\n        }\r\n        return pageArr;\r\n    }\r\n\r\n    /**\r\n     * long 型日期转化为 format 格式\r\n     * @param longTime long型日期时间\r\n     * @param format 形如 'yyyy-MM-dd'\r\n     * @returns {*}\r\n     */\r\n    function formatDate(longTime, format) {\r\n        return new Date(longTime || 1000000000000).format(format || 'yyyy-MM-dd')\r\n    }\r\n    Date.prototype.format = Date.prototype.format || function(format) {\r\n        var date = {\r\n            \"M+\": this.getMonth() + 1,\r\n            \"d+\": this.getDate(),\r\n            \"h+\": this.getHours(),\r\n            \"m+\": this.getMinutes(),\r\n            \"s+\": this.getSeconds(),\r\n            \"q+\": Math.floor((this.getMonth() + 3) / 3),\r\n            \"S+\": this.getMilliseconds()\r\n        };\r\n        if (/(y+)/i.test(format)) {\r\n            format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));\r\n        }\r\n        for (var k in date) {\r\n            if (new RegExp(\"(\" + k + \")\").test(format)) {\r\n                format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? date[k] : (\"00\" + date[k]).substr((\"\" + date[k]).length));\r\n            }\r\n        }\r\n        return format;\r\n    }\r\n\r\n    //生成分页数据\r\n    var pageArr = getPageList(pageTotal, pageNo);\r\n    //判断是否有合同id，如果有添加到querystring\r\n    var sContractId = cid ? '&cid=' + cid : '';\r\n\r\nfor(var i=0; i<list.length; i++) {\r\n    var listTmp = list[i];\r\n    var curType = list[i].currentType;\r\n    var payState = _payStateInfo(listTmp.status);\r\n%>\r\n<div class=\"z_item\" data-id=\"<%= listTmp.id %>\" data-cid=\"<%= listTmp.contractId %>\">\r\n    <div class='z_title'>\r\n        <% if (!listTmp.isC2B) { %>\r\n            <span><%=payState.text%></span>\r\n        <% } %>\r\n        <%if(listTmp.status!=2&&listTmp.status!=4&&listTmp.status!=6&&listTmp.billRole=='tenant' && !listTmp.isC2B){%>\r\n        <div data-ids=\"<%= listTmp.ids.join(',') %>\" class=\"payBill\">去支付\r\n        <span class=\"pay-loading\">...</span>\r\n        </div>\r\n        <%}%>\r\n        <% if (listTmp.status == 2) { %>\r\n        <a class=\"serial-btn\" data-contractId=\"<%= listTmp.contractId %>\" data-billOrder=\"<%= listTmp.billOrder %>\">流水信息</a>\r\n        <% } %>\r\n    </div>\r\n    <div class='z_body'>\r\n        <div>第<%= listTmp.billOrder %>期账单</div>\r\n        <div class='amount'>￥<%= (listTmp.payExpense/100).toFixed(2) %><% if(!!payState.tips&&listTmp.billRole=='tenant') { %><span class=\"payTips\"><%= payState.tips %></span><% } %></div>\r\n        <div>账单明细：\r\n        <% if(listTmp.billOrder == 1) { %>\r\n        押金￥<%= (listTmp.depositExpense/100).toFixed(2) %>/\r\n        <% } %>\r\n        租金￥<%= (listTmp.expense/100).toFixed(2) %>\r\n        </div>\r\n        <div>账单周期： <%= formatDate(listTmp.scheduleBegin) %> 至 <%= formatDate(listTmp.scheduleEnd) %></div>\r\n        <div>合同编号： <%= listTmp.contractNo || '*******' %></div>\r\n    </div>\r\n</div>\r\n<% } %>\r\n<% if (pageTotal > 1 /* 大于一页才显示分页 */) { %>\r\n<div class=\"lp-main-page\">\r\n    <% if (pageNo > 1) { %>\r\n    <a href=\"<%= '/pc/user/listOfBills?type='+ type +'&pageNo='+ (pageNo - 1) + sContractId %>\" class=\"page-prev\">上一页</a>\r\n    <% } %>\r\n    <% for(var i = 0; i < pageArr.length; i++) { %>\r\n    <a class=\"page-num <%= pageArr[i] == pageNo ? 'cur' : '' %>\" href=\"<%= '/pc/user/listOfBills?type='+ type +'&pageNo='+ pageArr[i] + sContractId %>\">\r\n        <%= pageArr[i] %>\r\n    </a>\r\n    <% } %>\r\n    <% if (pageNo < pageTotal ) { %>\r\n    <a href=\"<%= '/pc/user/listOfBills?type='+ type +'&pageNo='+ (pageNo + 1) + sContractId %>\" class=\"page-next\">下一页</a>\r\n    <% } %>\r\n    <span class='page-total'>共<%= pageTotal %>页</span>\r\n</div>\r\n<% } %>",serialTpl:'<%\r\n    /**\r\n     * 依据账单不同状态返回对应的状态信息。\r\n     * @param state 0-未激活，1-激活，2-已支付，3-逾期，4-支付中，5-支付失败，6-失效。\r\n     * @returns {*}\r\n     */\r\n    function _payStateInfo(state) {\r\n        switch (~~state) {\r\n            case 0:\r\n            case 1:\r\n            case 5:  // 支付失败，C端统一显示“待支付”\r\n                return {\r\n                    stateclass: \'unpay\',\r\n                    text: window.curRentType ? \'待收款\' : \'待支付\'\r\n                }\r\n            case 2:\r\n                return {\r\n                    stateclass: \'paid\',\r\n                    text: window.curRentType ? \'已收款\' : \'已支付\'\r\n                }\r\n            case 3:\r\n                return {\r\n                    stateclass: \'unpay\',\r\n                    text: window.curRentType ? \'待收款\' : \'待支付\',\r\n                    tips: \'已逾期，请尽快支付以免影响您的信用\',\r\n                }\r\n            case 4:\r\n                return {\r\n                    stateclass: \'paying\',\r\n                    text: \'支付中\'\r\n                }\r\n            case 6:\r\n                return {\r\n                    stateclass: \'paid\',\r\n                    text: \'失效\'\r\n                }\r\n            default:\r\n                return {\r\n                    stateclass: \'unpay\',\r\n                    text: window.curRentType ? \'待收款\' : \'待支付\'\r\n                }\r\n        }\r\n    }\r\n    function _getCheckOrderStatus(status) {\r\n        if(!status){\r\n            return "未对账"\r\n        }else {\r\n            return {\r\n                1: "对账成功",\r\n                2: "对账失败"\r\n            }[status]\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 将分为单位的金额转换为千分逗号分隔\r\n     * @param {number} money 分为单位的金额\r\n     * @return {number}\r\n     */\r\n    function _convertMoney(money) {\r\n        var _m = (money / 100).toFixed(2);\r\n        return numberHelper.format(_m);\r\n    }\r\n%>\r\n<% if (type == 0 /* 租客 */) { %>\r\n<ul class="serial-list">\r\n    <li class="head-box">\r\n        <h3 class="money">￥<%= _convertMoney(data.payExpense) %></h3>\r\n        <span class="desc">实付金额</span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">账单类型</span>\r\n        <span class="item-right">\r\n        <% if (data.billOrder == 1) { %>\r\n        租金/押金账单\r\n        <% } else { %>\r\n        租金账单\r\n        <% } %>\r\n        </span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">房源名称</span>\r\n        <span class="item-right"><%= data.houseName %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">账单编号</span>\r\n        <span class="item-right"><%= data.billNo %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">交易流水号</span>\r\n        <span class="item-right"><%= data.transactionNo %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">支付状态</span>\r\n        <span class="item-right"><%= _payStateInfo(data.status).text %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">付款时间</span>\r\n        <span class="item-right"><%= data.paidTime %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">创建时间</span>\r\n        <span class="item-right"><%= data.createTime %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">修改时间</span>\r\n        <span class="item-right"><%= data.updateTime %></span>\r\n    </li>\r\n</ul>\r\n<% } else if (type == 1  /* 房东 */) { %>\r\n<ul class="serial-list">\r\n    <li class="head-box">\r\n        <h3 class="money">￥<%= _convertMoney(data.payExpense) %></h3>\r\n        <span class="desc">实收金额</span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">账单类型</span>\r\n        <span class="item-right">\r\n        <% if (data.billOrder == 1) { %>\r\n        租金/押金账单\r\n        <% } else { %>\r\n        租金账单\r\n        <% } %>\r\n        </span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">房源名称</span>\r\n        <span class="item-right"><%= data.houseName %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">账单编号</span>\r\n        <span class="item-right"><%= data.billNo %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">收款状态</span>\r\n        <span class="item-right"><%= _payStateInfo(data.status).text %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">收款时间</span>\r\n        <span class="item-right"><%= data.paidTime %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">对账状态</span>\r\n        <span class="item-right"><%= _getCheckOrderStatus(data.checkOrderStatus) %></span>\r\n    </li>\r\n    <% if (data.checkOrderStatus && data.checkOrderTime) { %>\r\n    <li class="serial-item">\r\n        <span class="item-left">对账时间</span>\r\n        <span class="item-right"><%= data.checkOrderTime %></span>\r\n    </li>\r\n    <% } %>\r\n    <li class="serial-item">\r\n        <span class="item-left">创建时间</span>\r\n        <span class="item-right"><%= data.createTime %></span>\r\n    </li>\r\n    <li class="serial-item">\r\n        <span class="item-left">修改时间</span>\r\n        <span class="item-right"><%= data.updateTime %></span>\r\n    </li>\r\n</ul>\r\n<% } %>',init:function(){var a=this;a.bindEvent(),a.getBillList(),n(".dialog-wrapper").dialog({customWraper:!0})},bindEvent:function(){var a=this;n(".z_bill_list").on("click",".payBill",function(){n(this).hasClass("pay-opacity")||(a.payLoadingImg(this),a.ids=String(n(this).data("ids")).split(","),a.queryIsOpenWallet(function(){a.payBill(a.ids)},function(){a.payRemoveLoadingImg(),n("#J_authorization_dialog").dialog("instance").open()}))}),n("#J_authorization_dialog").on("click",".close-btn,.btn-gray",function(){n("#J_authorization_dialog").dialog("instance").close()}),n("#J_agree").on("click",function(){n("#J_authorization_dialog").dialog("instance").close(),a.payBill(a.ids)}),n("#J_serial_dialog").on("click",".close-btn",function(){n("#J_serial_dialog").dialog("instance").close()}),n(".z_bill_list").on("click",".serial-btn",function(){var r=n(this).data("contractid"),t=n(this).data("billorder");a.getBillDetail(r,t)}),n("#J_payByH5_dialog").on("click",".close-btn",function(){n("#J_payByH5_dialog").dialog("instance").close(),clearInterval(i)})},payBill:function(n){var a=this,e=encodeURIComponent(location.origin+"/h5/user/index"),s={frontEndUrl:e,orderCurrency:"CNY",orderIds:n};t({url:a.config.payBill,type:"POST",contentType:"application/json;charset=utf-8",data:JSON.stringify(s),success:function(n){a.payRemoveLoadingImg(),200===n.status?a.showPayByH5Dialog(n.data.cashierUrl):r.show(n.message)},error:function(){a.payRemoveLoadingImg(),r.show("接口获取失败！")}})},getBillList:function(){var a=this,s=a.config.billListUrl+"/app",i={pageNo:window.pageNo,pageSize:10,type:"all",isInactive:!0};0==window.curRentType?i.type="tenant":1==window.curRentType&&(i.type="owner",i.order="paidTime"),window.curcid&&(i.contractId=window.curcid),t({url:s,type:"GET",data:i,success:function(t){if(t.success){var s=t.data.list;if(s.length){for(var i=0;i<s.length;i++)s[i].isC2B=2==s[i].contractType||4==s[i].contractType||5==s[i].contractType,s[i].currentType=window.curRentType;var l=[];l.push(e.parse(a.billList,{list:s,type:window.curRentType,pageNo:window.pageNo,total:t.data.total,pageTotal:t.data.pageTotal,cid:window.curcid})),n(".z_bill_list").html(l.join(""))}else n("#J_no_info").show()}else r.show(t.msg)},error:function(){r.show("接口获取失败！")}})},getBillDetail:function(n,a){var e=this,s=e.config.billDetailUrl+"/"+n+"/"+a;t({url:s,type:"GET",success:function(n){n.success?e.showSerialInfo(n.data):r.show(n.msg)},error:function(){r.show("接口获取失败！")}})},showSerialInfo:function(a){var r=this,t=e.parse(r.serialTpl,{type:window.curRentType,data:a,numberHelper:s});n(".serial-wrapper").html(t),n("#J_serial_dialog").dialog("instance").open()},queryIsOpenWallet:function(n,a){var e=this;t({url:e.config.isOpenWallet,type:"GET",success:function(t){200===t.status?t.data.isRegister?n.call(e):(e.payRemoveLoadingImg(),a.call(e)):(e.payRemoveLoadingImg(),r.show(t.message))},error:function(n){e.payRemoveLoadingImg(),console.log(n)}})},showPayByH5Dialog:function(a){n("#J_payByH5_qrcode").empty(),n("#J_payByH5_qrcode").qrcode({render:"canvas",width:160,height:160,text:a}),n("#J_payByH5_dialog").dialog("instance").open(),this.pollingBillStatus(this.ids)},pollingBillStatus:function(a){var e=this;i=setInterval(function(){t({url:e.config.billStatusUrl,type:"get",data:{orderIds:a.join(",")},success:function(a){200===a.status?0!==a.data&&(n("#J_payByH5_dialog").dialog("instance").close(),location.reload()):r.show(a.message)},error:function(n){console.log(n)}})},2e3)},payLoadingImg:function(a){n(a).children(".pay-loading").addClass("pay-loading-unnone"),n(".payBill").addClass("pay-opacity")},payRemoveLoadingImg:function(){n(".pay-loading").removeClass("pay-loading-unnone"),n(".payBill").removeClass("pay-opacity")}};l.init()})});